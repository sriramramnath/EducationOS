<!DOCTYPE html>
<html>

<head>
  {% load static %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eduverse Â· Productivity cockpit</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <link rel="stylesheet" href="{% static 'google-style.css' %}">
</head>

<body class="bg-canvas">
  <div class="app-container container-xxl py-4">
    <header class="app-header" role="banner">
      <div class="app-logo">
        <div class="app-mark">EV</div>
        <div>
          <h1>Eduverse</h1>
          <p class="app-subtitle">Unified flow for Gmail, Tasks & Calendar</p>
        </div>
      </div>
      <nav class="app-user" aria-label="User navigation">
        {% if user_data.picture %}
        <img src="{{ user_data.picture }}" alt="Profile picture" class="header-profile-pic">
        {% else %}
        <div class="header-profile-placeholder">{{ user_data.email|slice:":1"|upper }}</div>
        {% endif %}
        <div class="header-meta">
          <span class="header-email">{{ user_data.email }}</span>
          {% if user_data.verified_email %}
          <span class="header-badge">Verified</span>
          {% endif %}
        </div>
        <a href="{% url 'logout' %}" class="header-logout" aria-label="Sign out">Sign out</a>
      </nav>
    </header>

    <main class="main-content" role="main">
      <section class="hero-panel card border-0 shadow-soft" aria-labelledby="hero-heading">
        <div class="hero-copy">
          <p class="hero-eyebrow">Daily snapshot</p>
          <h2 class="hero-title" id="hero-heading">
            {{ user_data.given_name|default:user_data.name|default:user_data.email }}, everything you need is here.
          </h2>
          <p class="hero-description">
            One quiet surface that mirrors the craft of Apple, Google and Microsoftâ€”simple cards, calm typography,
            zero clutter.
          </p>
        </div>
      </section>

      <section class="workspace">
        <nav class="view-tabs nav nav-pills nav-fill" role="tablist" aria-label="Workspace sections">
          <button type="button" class="view-tab nav-link active" role="tab" aria-selected="true"
            data-tab-target="#tab-snapshot">
            <span class="fw-semibold">Snapshot</span>
            <small>Overview</small>
          </button>
          <button type="button" class="view-tab nav-link" role="tab" aria-selected="false" data-tab-target="#tab-inbox">
            <span class="fw-semibold">Inbox</span>
            <small>Gmail</small>
          </button>
          <button type="button" class="view-tab nav-link" role="tab" aria-selected="false" data-tab-target="#tab-tasks">
            <span class="fw-semibold">Tasks</span>
            <small>Google Tasks</small>
          </button>
          <button type="button" class="view-tab nav-link" role="tab" aria-selected="false"
            data-tab-target="#tab-calendar">
            <span class="fw-semibold">Calendar</span>
            <small>30 days</small>
          </button>
          <button type="button" class="view-tab nav-link" role="tab" aria-selected="false" data-tab-target="#tab-focus">
            <span class="fw-semibold">Focus</span>
            <small>Pomodoro</small>
          </button>
        </nav>

        <div class="tab-panels">
          <!-- Snapshot Tab -->
          <article class="tab-panel active" id="tab-snapshot" role="tabpanel" aria-label="Snapshot panel">
            <div class="panel-header compact">
              <div>
                <p class="panel-label">Snapshot</p>
                <h3>Daily overview</h3>
              </div>
            </div>
            <div id="snapshot-react" class="snapshot-react" aria-live="polite"></div>
          </article>

          <!-- Gmail Tab -->
          <article class="tab-panel" id="tab-inbox" role="tabpanel" aria-label="Inbox panel">
            <div class="panel-header">
              <div>
                <p class="panel-label">Inbox</p>
                <h3>Latest threads</h3>
              </div>
              <button class="panel-link ghost" id="refresh-email-btn">Refresh</button>
            </div>

            <div class="permission-banner subtle" id="email-permission-banner" style="display:none;">
              <div class="permission-banner-content">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                </svg>
                <div class="permission-banner-text">
                  <strong>Reconnect Gmail</strong>
                  <p>Sign out and sign back in so Eduverse can pull your inbox again.</p>
                </div>
                <a href="{% url 'logout' %}" class="permission-banner-btn">Re-authenticate</a>
              </div>
            </div>

            <div class="inbox-shell" id="inbox-shell">
              <div class="email-list-pane">
                <div class="skeleton-list" id="email-skeleton">
                  <div class="skeleton-row"></div>
                  <div class="skeleton-row"></div>
                  <div class="skeleton-row"></div>
                </div>
                <div class="gmail-email-list" id="email-list" aria-live="polite"></div>
                <div class="gmail-empty-state" id="email-empty-state" style="display:none;">
                  <div class="empty-icon">âœ¨</div>
                  <h3>Inbox zero feels good</h3>
                  <p>Once a new email arrives the feed will update automatically.</p>
                </div>
              </div>
              <aside class="email-detail-pane hidden" id="email-detail-pane">
              </aside>
            </div>
          </article>

          <!-- Tasks Tab -->
          <article class="tab-panel" id="tab-tasks" role="tabpanel" aria-label="Tasks panel">
            <div class="panel-header">
              <div>
                <p class="panel-label">Tasks</p>
                <h3>Google Tasks</h3>
              </div>
              <div class="panel-actions">
                <button class="panel-link ghost" id="refresh-tasks-btn">Refresh</button>
                <button class="panel-link" id="add-task-btn">New task</button>
              </div>
            </div>

            <div class="permission-banner subtle" id="tasks-permission-banner" style="display:none;">
              <div class="permission-banner-content">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-5-5 1.41-1.41L11 14.17l5.59-5.59L18 10l-7 7z" />
                </svg>
                <div class="permission-banner-text">
                  <strong>Tasks access missing</strong>
                  <p>Sign out/in again so Google issues a Tasks + Calendar token.</p>
                </div>
                <a href="{% url 'logout' %}" class="permission-banner-btn">Reconnect Google</a>
              </div>
            </div>

            <section class="gtasks-container">
              <div class="gtasks-list" id="gtasks-list"></div>
              <div class="gtasks-empty" id="tasks-empty-state" style="display:none;">
                <p>No tasks yet. Capture one with the button above.</p>
              </div>
            </section>
          </article>

          <!-- Calendar Tab -->
          <article class="tab-panel" id="tab-calendar" role="tabpanel" aria-label="Calendar panel">
            <div class="panel-header">
              <div>
                <p class="panel-label">Calendar</p>
                <h3>30-day horizon</h3>
              </div>
              <button class="panel-link ghost" id="refresh-calendar-btn">Refresh</button>
            </div>

            <div class="permission-banner subtle" id="calendar-permission-banner" style="display:none;">
              <div class="permission-banner-content">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                </svg>
                <div class="permission-banner-text">
                  <strong>Calendar permission required</strong>
                  <p>Google Calendar scope is missing. Re-authenticate to pull events.</p>
                </div>
                <a href="{% url 'logout' %}" class="permission-banner-btn">Re-authenticate</a>
              </div>
            </div>

            <div class="data-surface">
              <div class="skeleton-list" id="calendar-skeleton">
                <div class="skeleton-row"></div>
                <div class="skeleton-row"></div>
              </div>
              <div class="gcal-events-list" id="calendar-events"></div>
              <div class="gcal-empty-state" id="calendar-empty-state" style="display:none;">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor" opacity="0.2">
                  <path
                    d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                </svg>
                <h3>No upcoming events</h3>
                <p>Your next 30 days are clear. Add something in Google Calendar and refresh.</p>
              </div>
            </div>
          </article>

          <!-- Focus Tab -->
          <article class="tab-panel" id="tab-focus" role="tabpanel" aria-label="Pomodoro panel">
            <div class="panel-header">
              <div>
                <p class="panel-label">Focus</p>
                <h3>Pomodoro cockpit</h3>
              </div>
            </div>

            <div class="focus-grid">
              <section class="focus-stack">
                <div class="timer-card focus-card" id="focus-card">
                  <div class="card-header">
                    <button id="back-to-break" class="back-btn" aria-label="Switch to break">â†º</button>
                    <div class="mode-dots">
                      <span class="dot active"></span>
                      <span class="dot"></span>
                    </div>
                  </div>

                  <div class="timer-display">
                    <div class="timer-circle">
                      <svg class="progress-svg" viewBox="0 0 300 300">
                        <circle class="progress-bg" cx="140" cy="140" r="120"></circle>
                        <circle class="focus-progress" id="focus-progress" cx="140" cy="140" r="120"></circle>
                      </svg>
                      <div class="progress-dot" id="focus-dot"></div>
                      <div class="timer-content">
                        <p class="time" id="focus-time">25:00</p>
                        <span class="session-label">Focus session</span>
                      </div>
                    </div>
                  </div>

                  <div class="session-info">
                    <div class="session-icon">ðŸ”¥</div>
                    <p class="session-title">Deep work</p>
                    <p class="session-copy">Stick with the sprint for a full 25 minutes.</p>
                  </div>

                  <div class="timer-controls">
                    <button class="control-btn" id="focus-btn">
                      <span class="btn-icon">â–¶</span>
                      <span class="btn-label">Start</span>
                    </button>
                  </div>

                  <div class="time-settings">
                    Focus
                    <input type="number" id="focus-minutes" value="25" min="1" max="60" aria-label="Focus minutes">
                    Break
                    <input type="number" id="break-minutes" value="5" min="1" max="30" aria-label="Break minutes">
                  </div>
                </div>

                <div class="timer-card break-card" id="break-card">
                  <div class="card-header">
                    <button id="back-to-focus" class="back-btn" aria-label="Switch to focus">â†º</button>
                    <div class="mode-dots">
                      <span class="dot"></span>
                      <span class="dot active"></span>
                    </div>
                  </div>

                  <div class="timer-display">
                    <div class="timer-circle">
                      <svg class="progress-svg" viewBox="0 0 300 300">
                        <circle class="progress-bg" cx="140" cy="140" r="120"></circle>
                        <circle class="break-progress" id="break-progress" cx="140" cy="140" r="120"></circle>
                      </svg>
                      <div class="progress-dot" id="break-dot"></div>
                      <div class="timer-content">
                        <p class="time" id="break-time">05:00</p>
                        <span class="session-label">Break time</span>
                      </div>
                    </div>
                  </div>

                  <div class="session-info">
                    <div class="session-icon">ðŸŒ¿</div>
                    <p class="session-title">Reset & breathe</p>
                    <p class="session-copy">Move around, drink water and get ready for the next sprint.</p>
                  </div>

                  <div class="timer-controls">
                    <button class="control-btn" id="break-btn">
                      <span class="btn-icon">â–¶</span>
                      <span class="btn-label">Start</span>
                    </button>
                  </div>
                </div>
              </section>

              <aside class="focus-sidebar">
                <div class="sidebar-card stats-card">
                  <div class="stat-row">
                    <p>Sessions today</p>
                    <strong id="completed-pomodoros">0</strong>
                  </div>
                  <div class="stat-row">
                    <p>Day streak</p>
                    <strong id="current-streak">0</strong>
                  </div>
                  <div class="stat-row subtle">
                    <p>Mode</p>
                    <span id="focus-mode-label">Focused</span>
                  </div>
                </div>

                <div class="sidebar-card agenda-card">
                  <div class="agenda-header">
                    <p class="panel-label">Upcoming sprints</p>
                    <span>Auto-loop</span>
                  </div>
                  <ul class="agenda-list">
                    <li>
                      <div>
                        <strong>Inbox triage</strong>
                        <p>Clear flagged mail in 1 Pomodoro</p>
                      </div>
                      <span>Now</span>
                    </li>
                    <li>
                      <div>
                        <strong>Design review</strong>
                        <p>Summarize feedback for tomorrow</p>
                      </div>
                      <span>14:30</span>
                    </li>
                    <li>
                      <div>
                        <strong>Break ritual</strong>
                        <p>Stretch + refill water</p>
                      </div>
                      <span>Next</span>
                    </li>
                  </ul>
                </div>

                <div class="sidebar-card ambient-card">
                  <div>
                    <p class="panel-label">Ambient mode</p>
                    <h4>Soft rain & piano</h4>
                    <p class="ambient-copy">Pair the timer with an unobtrusive loop. Keeps you in the zone.</p>
                  </div>
                  <button class="ambient-toggle" id="ambient-toggle">Play soundscape</button>
                </div>
              </aside>
            </div>
          </article>
        </div>
      </section>
    </main>
  </div>

  <div class="gtasks-modal" id="add-task-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
    <div class="gtasks-modal-content">
      <div class="gtasks-modal-header">
        <input type="text" id="task-title" placeholder="Title" class="gtasks-title-input" aria-label="Task title"
          required autofocus>
        <button class="gtasks-modal-close" id="close-modal" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
        </button>
      </div>
      <div class="gtasks-modal-body">
        <textarea id="task-description" placeholder="Add details" class="gtasks-details-input"
          aria-label="Task description"></textarea>
      </div>
      <div class="gtasks-modal-footer">
        <button class="gtasks-btn-text" id="cancel-task">Cancel</button>
        <button class="gtasks-btn-primary" id="save-task">Save</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    {% verbatim %}
    const StatTile = ({ label, value, meta }) => (
      <div className="col-6">
        <div className="react-stat">
          <p className="react-stat-label">{label}</p>
          <p className="react-stat-value">{value}</p>
          <span className="react-stat-meta">{meta}</span>
        </div>
      </div>
    );

    const SnapshotPanel = ({ emails = [], tasks = [], events = [] }) => {
      const activeTasks = tasks.filter((task) => {
        const status = (task.status || '').toLowerCase();
        return status !== 'completed' && status !== 'done';
      }).length;

      const stats = [
        { label: 'Inbox', value: emails.length, meta: 'messages synced' },
        { label: 'Active tasks', value: activeTasks, meta: 'need action' },
        { label: 'Total tasks', value: tasks.length, meta: 'Google Tasks' },
        { label: 'Events', value: events.length, meta: 'next 30 days' },
      ];

      const baseline = [32, 58, 44, 72, 55, 80, 60];
      const load = emails.length + tasks.length + events.length;
      const sparkData = baseline.map((value, index) => {
        const adjustment = (load % 12) - 6 + index;
        return Math.min(95, Math.max(12, value + adjustment));
      });
      const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      return (
        <div className="row g-4 react-grid">
          <div className="col-12 col-lg-7">
            <div className="react-panel h-100">
              <div className="react-panel-header mb-3">
                <div>
                  <p className="panel-label mb-1">Today</p>
                  <h4 className="react-panel-title">Signal at a glance</h4>
                </div>
                <span className="react-panel-meta text-uppercase">API live feed</span>
              </div>
              <div className="row g-3">
                {stats.map((stat) => (
                  <StatTile key={stat.label} {...stat} />
                ))}
              </div>
            </div>
          </div>
          <div className="col-12 col-lg-5">
            <div className="react-panel h-100">
              <div className="react-panel-header mb-3">
                <div>
                  <p className="panel-label mb-1">Momentum</p>
                  <h4 className="react-panel-title">Focus trend</h4>
                </div>
                <span className="react-panel-meta">Last 7 days</span>
              </div>
              <div className="spark-stack">
                {sparkData.map((value, index) => (
                  <div className="spark-bar" key={dayLabels[index]}>
                    <div className="spark-bar-fill" style={{ height: `${value}%` }}></div>
                    <small>{dayLabels[index]}</small>
                  </div>
                ))}
              </div>
              <p className="spark-caption text-muted mt-3">
                Generated from the latest Gmail, Tasks and Calendar signals.
              </p>
            </div>
          </div>
        </div>
      );
    };

    window.renderSnapshotReact = function (payload) {
      const target = document.getElementById('snapshot-react');
      if (!target) return;
      if (!target._reactRoot) {
        target._reactRoot = ReactDOM.createRoot(target);
      }
      target._reactRoot.render(
        <SnapshotPanel emails={payload.emails} tasks={payload.tasks} events={payload.events} />
      );
    };
    {% endverbatim %}
  </script>
  <script src="{% static 'app.js' %}"></script>
</body>

</html>
